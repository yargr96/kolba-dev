class Calculator {
    constructor({range, socials, flask, countContainer}) {
        this._range = range;
        this._socials = socials;
        this._flask = flask;
        this._countContainer = countContainer;

        this._onChange = this._onChange.bind(this);
        range.onChange = this._onChange;
        socials.onChange = this._onChange;

        this._setMaxPrice();
        this._render();
    }

    _onChange() {
        this._render();
    }

    _render() {
        this._countContainer.textContent = this.priceFormatted;
        this._flask.fullness = this._priceFullness;
    }

    _setMaxPrice() {
        const postsCount = this._range.max;
        const socialsCount = this._socials.totalCount;

        this._maxPrice = (socialsCount - (socialsCount - 1) / 2) * (postsCount * 400) + postsCount * 400;
    }

    get price() {
        const postsCount = this._range.value;
        const {count: socialsCount, designDecoration} = this._socials.value;

        if (!socialsCount) return 0;
        
        let designPrice = 0;
        if (designDecoration) designPrice = postsCount * 400;

        return (socialsCount - (socialsCount - 1) / 2) * (postsCount * 400) + designPrice;
    }

    get priceFormatted() {
        let i = 0;

        return String(this.price).split('').reduceRight((acc, char) => {
            i++;
            
            if (i % 3 === 0) return char + " " + acc;
            return char + acc;
        })
    }

    get _priceFullness() {
        return this.price / this._maxPrice;
    }
}
class FlaskSection {
    constructor(section) {
        this._section = section;
        this._DEFAUTL_WIDTH = 505;
        this._DEFAUTL_HEIGHT = 550;
        this._DEFAUTL_PADDING_TOP = 102;
        this._proportion = this._DEFAUTL_HEIGHT / this._DEFAUTL_WIDTH;
        this._paddingProportion = this._DEFAUTL_PADDING_TOP / this._DEFAUTL_WIDTH;

        this._setProportions = this._setProportions.bind(this);
        this._setProportions();
        window.addEventListener('resize', this._setProportions);
    }

    _setProportions() {
        const width = parseFloat(getComputedStyle(this._section).width);
        this._section.style.height = width * this._proportion + 'px';
        this._section.style.paddingTop = width * this._paddingProportion + 'px';
    }
}
class Flask {
    constructor({flask, fullness = 0}) {
        this._flask = flask;
        this._fullness = fullness;
        this._filler = this._flask.querySelector('.flask__full');

        this._MAX_FILLER_HEIGHT = 100;
        this._MIN_FILLER_HEIGHT = 14;

        this._fillerHeightRange = this._MAX_FILLER_HEIGHT - this._MIN_FILLER_HEIGHT;

        this._setFillerHeight();

        this._DEFAULT_WIDTH = 505;
        this._DEFAULT_HEIGHT = 379;
        this._proportion = this._DEFAULT_HEIGHT / this._DEFAULT_WIDTH;
        this._setProportions = this._setProportions.bind(this);
        this._setProportions();
        window.addEventListener('resize', this._setProportions);
    }

    _setFillerHeight() {
        let height;
        
        if (this._fullness === 0) {
            height = 0;
        } else {
            height = this._fillerHeightRange * this._fullness + this._MIN_FILLER_HEIGHT;
        }

        this._filler.style.height = height + '%';
    }

    _setProportions() {
        const width = parseFloat(getComputedStyle(this._flask).width);
        this._flask.style.height = width * this._proportion + 'px';
    }

    set fullness(value) {
        this._fullness = value;
        this._setFillerHeight();
    }
}
class Range {
    constructor({rangeNode, min, max, step, value, onChange}) {
        this._rangeNode = rangeNode;
        this.min = min;
        this.max = max;
        this._step = step;

        if (onChange) this.onChange = onChange;

        this._filled = this._rangeNode.querySelector('.range__filled');
        this._thumb = this._rangeNode.querySelector('.range__thumb');
        this._count = this._rangeNode.querySelector('.range__count');

        this._onMouseDown = this._onMouseDown.bind(this);
        this._onMouseMove = this._onMouseMove.bind(this);
        this._onMouseUp = this._onMouseUp.bind(this);

        this._thumb.addEventListener('mousedown', this._onMouseDown);
        this._thumb.addEventListener('touchstart', this._onMouseDown);

        window.addEventListener('mouseup', this._onMouseUp);
        window.addEventListener('touchend', this._onMouseUp);

        this._stepsCount = (this.max - this.min) / this._step;

        this.value = value === undefined ? this.min : value;

        this._setRangeCoordinates = this._setRangeCoordinates.bind(this);
        this._setRangeCoordinates();
        window.addEventListener('resize', this._setRangeCoordinates);

        this._setThumbPosition();

        this._mousePressed = false;
    }

    _setRangeCoordinates() {
        const rangeRect = this._rangeNode.getBoundingClientRect();
        const {left, right} = rangeRect;
        const rangeLength = right - left;

        this._leftRangeCoordinate = left;
        this._stepLength = rangeLength / this._stepsCount;
    }

    _onMouseDown(e) {
        if (!e.target.classList.contains('range__thumb')) return;
        if (this._mousePressed) return;
        
        window.addEventListener('mousemove', this._onMouseMove);
        window.addEventListener('touchmove', this._onMouseMove);

        document.body.classList.add('not-selectable');
        this._mousePressed = true;
    }

    _onMouseMove(e) {
        if (!this._mousePressed) return;

        const mouseX = e.pageX || e.changedTouches[0].pageX;        
        const mouseOffset = mouseX - this._leftRangeCoordinate;

        let value = Math.round(mouseOffset / this._stepLength) * this._step + this.min;

        if (value < this.min) value = this.min;
        if (value > this.max) value = this.max;
        
        this.value = value;
    }

    _onMouseUp() {
        window.removeEventListener('mousemove', this._onMouseMove);
        document.body.classList.remove('not-selectable');
        
        this._mousePressed = false;
    }

    _setThumbPosition() {
        const offset = (this._value - this.min) * this._stepLength / this._step;

        this._filled.style.width = offset + 'px';
        this._thumb.style.left = offset + 'px';
    }

    get value() {
        return this._value;
    }

    set value(val) {
        this._value = val;

        this._setThumbPosition();
        this._count.textContent = val;

        this.onChange && this.onChange(val);
    }
}
class Socials {
    constructor({socialsList, designCheckbox, onChange}) {
        this._socialsList = socialsList;
        this._designCheckbox = designCheckbox;

        if (onChange) this.onChange = onChange;

        this._onSocialsChange = this._onSocialsChange.bind(this);
        this._onDesignDecorationChange = this._onDesignDecorationChange.bind(this);

        this._socialsList.forEach(checkbox => {
            checkbox.addEventListener('change', this._onSocialsChange);
        })

        this._designCheckbox.addEventListener('change', this._onDesignDecorationChange);

        this._checkSocials();
        this._checkDesignDecoration();
    }

    _checkSocials() {
        let count = 0;

        this._socialsList.forEach(checkbox => {
            if (checkbox.checked) count++;
        });

        this._socialsCount = count;
    }

    _checkDesignDecoration() {
        this._designDecoration = this._designCheckbox.checked;
    }

    _onSocialsChange() {
        this._checkSocials();
        this.onChange && this.onChange(this.value);
    }

    _onDesignDecorationChange() {
        this._checkDesignDecoration();
        this.onChange && this.onChange(this.value);
    }

    get value() {
        return {
            count: this._socialsCount,
            designDecoration: this._designDecoration
        }
    }

    get totalCount() {
        return this._socialsList.length;
    }
}
const popup = ({ linkToPopupSelector, closePopupSelector, popupSelector}) => {
    const linksToPopup = document.querySelectorAll(linkToPopupSelector);
    const closePopupItems = document.querySelectorAll(closePopupSelector);
    const popup = document.querySelector(popupSelector);
    const pageWrapper = document.querySelector('.page-wrapper');

    const requestForm = document.querySelector('.request-form');
    const thankyou = document.querySelector('.thankyou');
    const error = document.querySelector('.error');
    const formInputs = document.querySelectorAll('.request-form__input');

    const clearPopup = () => {
        requestForm.style.display = null;
        thankyou.style.display = "none";
        error.style.display = "none";
        formInputs.forEach(input => input.value = '');
    }

    const openPopup = () => {
        clearPopup();

        popup.style.display = null;
        requestAnimationFrame(() => popup.classList.add('active'));

        const scrollBarWidth = window.innerWidth - document.body.getBoundingClientRect().width;

        pageWrapper.classList.add('page-wrapper_blured');
        document.body.classList.add('overflow-hidden');
        document.documentElement.classList.add('overflow-hidden');
        document.body.style.paddingRight = scrollBarWidth + 'px';
    };

    const closePopup = () => {
        popup.classList.remove('active');
        pageWrapper.classList.remove('page-wrapper_blured');

        setTimeout(() => {
            popup.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            document.documentElement.classList.remove('overflow-hidden');
            document.body.style.paddingRight = null;
        }, 200)
    }
    

    linksToPopup.forEach(el => {
        el.addEventListener('click', e => {
            e.preventDefault();
            openPopup();
        })
    });

    closePopupItems.forEach(el => {
        el.addEventListener('click', e => {
            e.preventDefault();
            closePopup()
        })        
    });
}
const submitForm = () => {
    const form = document.querySelector('.request-form');
    let pending = false;

    const handleSubmit = function(e) {
        e.preventDefault();
        if (pending) return;

        const {
            name: {value: name}, 
            phone: {value: phone}, 
            email: {value: email}
        } = this.elements;

        const params = new URLSearchParams();
        params.append('name', name);
        params.append('phone', phone);
        params.append('email', email);

        pending = true;
        axios.post('/mail.php', params)
            .then(res => {               
                if (res.statusText === "OK") {
                console.log(res);

                    document.querySelector('.request-form').style.display = "none";
                    document.querySelector('.thankyou').style.display = "block";
                } else {
                    throw new Error();
                }
            })
            .catch(err => {
                document.querySelector('.request-form').style.display = "none";
                document.querySelector('.error').style.display = "block";
                console.error(err);
            })
            .finally(() => pending = false);
    }

    form.addEventListener('submit', handleSubmit);
}
document.addEventListener('DOMContentLoaded', () => {
    const range = new Range({
        rangeNode: document.querySelector('.range'),
        min: 13,
        max: 69,
        step: 4,
        value: 21
    });

    const socials = new Socials({
        socialsList: document.querySelectorAll('.checkbox__input_social'),
        designCheckbox: document.querySelector('.checkbox__input_design')
    });

    const flask = new Flask({
        flask: document.querySelector('.flask')
    })

    new FlaskSection(document.querySelector('.calculator-section__flask-section'));

    new Calculator({
        range,
        socials,
        flask,
        countContainer: document.querySelector('.calculator-section__total-count')
    });

    popup({
        linkToPopupSelector: '.popup-link',
        closePopupSelector: '.close-popup',
        popupSelector: '#request-popup'
    });

    document.querySelectorAll('.request-form__input_phone').forEach(el => {
        const inputMask = new Inputmask('+7(999)999-99-99', {
            showMaskOnHover: false,
            clearIncomplete: true
        });
        
        inputMask.mask(el);
    })

    submitForm();
})